# SYNOPSIS:
#
#   make [all]  - makes everything.
#   make TARGET - makes the given target.
#   make clean  - removes all files generated by make.

GTEST_DIR = ../googletest

CJSON_DIR = ../cJSON

SRC_DIR = ../src

CPPFLAGS += -I$(GTEST_DIR)/include -I$(CJSON_DIR)

CXXFLAGS += -g -Wall -Wextra -pthread 

PROJECT = cashier

TESTS = commodity_test.out shopping_item_test.out \
				promotions_test.out commodity_map_test.out \
				shopping_cart_test.out shop_test.out

GTEST_HEADERS = $(GTEST_DIR)/include/gtest/*.h \
                $(GTEST_DIR)/include/gtest/internal/*.h

all : $(PROJECT) 
	
test : $(TESTS)

clean :
	rm -f $(TESTS) cashier *.out *.a *.o

# Builds gtest.a and gtest_main.a.

GTEST_SRCS_ = $(GTEST_DIR)/src/*.cc $(GTEST_DIR)/src/*.h $(GTEST_HEADERS)

gtest-all.o : $(GTEST_SRCS_)
	$(CXX) $(CPPFLAGS) -I$(GTEST_DIR) $(CXXFLAGS) -c \
            $(GTEST_DIR)/src/gtest-all.cc

gtest_main.o : $(GTEST_SRCS_)
	$(CXX) $(CPPFLAGS) -I$(GTEST_DIR) $(CXXFLAGS) -c \
            $(GTEST_DIR)/src/gtest_main.cc

gtest.a : gtest-all.o
	$(AR) $(ARFLAGS) $@ $^

gtest_main.a : gtest-all.o gtest_main.o
	$(AR) $(ARFLAGS) $@ $^

# cJSON
cjson.o : $(CJSON_DIR)/cjson.c
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c $^ -o $@

# commodity
commodity.o : $(SRC_DIR)/commodity.cc
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c $(SRC_DIR)/commodity.cc -o $@

commodity_test.o : $(SRC_DIR)/commodity_test.cc
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c $(SRC_DIR)/commodity_test.cc -o $@

commodity_test.out : commodity.o commodity_test.o	gtest_main.a
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -lpthread $^ -o $@

# shopping_item
shopping_item.o : $(SRC_DIR)/shopping_item.cc 
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c $(SRC_DIR)/shopping_item.cc -o $@

shopping_item_test.o : $(SRC_DIR)/shopping_item_test.cc
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c $(SRC_DIR)/shopping_item_test.cc -o $@

shopping_item_test.out : shopping_item.o shopping_item_test.o commodity.o gtest_main.a
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -lpthread $^ -o $@

# Promotions
promotions.o : $(SRC_DIR)/promotions.cc
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c $(SRC_DIR)/promotions.cc -o $@

rebate_promotions.o : $(SRC_DIR)/rebate_promotions.cc
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c $(SRC_DIR)/rebate_promotions.cc -o $@

promotions_test.o : $(SRC_DIR)/promotions_test.cc
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c $(SRC_DIR)/promotions_test.cc -o $@

promotions_test.out : promotions.o rebate_promotions.o \
									promotions_test.o shopping_item.o gtest_main.a
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -lpthread $^ -o $@

# Commodity_Map
commodity_map.o : $(SRC_DIR)/commodity_map.cc
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c $(SRC_DIR)/commodity_map.cc -o $@

commodity_map_test.o : $(SRC_DIR)/commodity_map_test.cc
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c $(SRC_DIR)/commodity_map_test.cc -o $@

commodity_map_test.out : commodity.o commodity_map.o \
												 commodity_map_test.o gtest_main.a \
												 promotions.o rebate_promotions.o cjson.o
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -lpthread $^ -o $@

# ShoppingCart

shopping_cart.o : $(SRC_DIR)/shopping_cart.cc
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c $(SRC_DIR)/shopping_cart.cc -o $@

shopping_cart_test.o : $(SRC_DIR)/shopping_cart_test.cc
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c $(SRC_DIR)/shopping_cart_test.cc -o $@

shopping_cart_test.out : shopping_item.o shopping_cart.o \
												 commodity.o commodity_map.o \
												 promotions.o rebate_promotions.o \
												 shopping_cart_test.o cjson.o gtest_main.a
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -lpthread $^ -o $@

# Shop
shop.o : $(SRC_DIR)/shop.cc
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c $(SRC_DIR)/shop.cc -o $@

shop_test.o : $(SRC_DIR)/shop_test.cc $(GTEST_HEADERS) 
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c $(SRC_DIR)/shop_test.cc -o $@

shop_test.out : shop.o shopping_cart.o shop_test.o gtest_main.a \
								commodity.o commodity_map.o promotions.o \
								rebate_promotions.o shopping_item.o cjson.o
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -lpthread $^ -o $@

# cashier
main.o : $(SRC_DIR)/main.cc
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c $(SRC_DIR)/main.cc -o $@

cashier : commodity.o promotions.o rebate_promotions.o shop.o \
					commodity_map.o shopping_item.o shopping_cart.o main.o \
					cjson.o
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -lpthread $^ -o $@
